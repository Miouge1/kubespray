---

- name: "Create CI namespace {{ test_name }} for test vms"
  k8s:
    name: "{{ test_name }}"
    kind: Namespace
    state: present
  register: create_ci_ns
  failed_when: not create_ci_ns.changed

- name: "Create temp dir /tmp/{{ test_name }} for CI files"
  file:
    path: "/tmp/{{ test_name }}"
    state: directory

- name: Template vm files for CI job
  template:
    src: "vm.yml.j2"
    dest: "/tmp/{{ test_name }}/instance-{{ vm_id }}.yml"
  loop: "{{ range(0, vm_count|int, 1) | list }}"
  loop_control:
    index_var: vm_id

- name: Start vms for CI job
  k8s:
    state: present
    src: "/tmp/{{ test_name }}/instance-{{ vm_id }}.yml"
  loop: "{{ range(0, vm_count|int, 1) | list }}"
  loop_control:
    index_var: vm_id

- name: Wait for vms to be scheduled
  shell: "kubectl get vmis -n {{ test_name }} instance-{{ vm_id }} -o json | jq '.status.interfaces[].ipAddress' | tr -d '\"'"
  register: vm_ips
  loop: "{{ range(0, vm_count|int, 1) | list }}"
  loop_control:
    index_var: vm_id
  retries: 20
  delay: 15
  failed_when: false
  until:
    - vm_ips.stdout | ipaddr

- name: Get VMI events
  shell: "kubectl -n {{ test_name }} get events --field-selector involvedObject.kind=VirtualMachineInstance"
  register: vm_events
  when: not (vm_ips.stdout | ipaddr)

- debug: msg="{{ vm_events.stdout.split('\n') }}"
  when: vm_events is defined
  failed_when: true

- name: "Create inventory for CI test in file /tmp/{{ test_name }}/inventory"
  template:
    src: "inventory.j2"
    dest: "{{ inventory_path }}"
  vars:
    vms: "{{ vm_ips }}"
